#! /usr/bin/env bash

spec_harness="${BASH_SOURCE[0]/bin\/spec}private/specHarness"
test_failed=
fail_fast=
name_matcher=
matcher_is_next=
spec_config=
spec_config_is_next=

declare -a testFiles=()

for arg in "$@"
do
  if [ "$spec_config_is_next" = "true" ]
  then
    spec_config_is_next=false
    spec_config="$arg"
  elif [ -f "$arg" ]
  then
    testFiles+=("$arg")
  elif [ "$arg" = "-f" ] || [ "$arg" = "--fast-fail" ] || [ "$arg" = "--fail-fast" ]
  then
    fail_fast=true
  elif [ "$arg" = "-e" ]
  then
    matcher_is_next=true
  elif [ "$matcher_is_next" = "true" ]
  then
    matcher_is_next=false
    name_matcher="$arg"
  elif [ "$arg" = "-c" ]
  then
    spec_config_is_next=true
  elif [ -d "$arg" ]
  then
    while read -rd '' specFile
    do
      testFiles+=("$specFile")
    done < <( find "$arg" -type f -name "*.spec.sh" -print0 )
  elif [ -n "$arg" ]
  then
    echo "Unsupported 'spec' argument: [$arg]" >&2
    exit 1
  fi
done

if [ "${#testFiles[@]}" -eq 0 ]
then
  while IFS= read -rd '' testFile; do testFiles+=("$testFile")
  done < <(find . -type d -name packages -prune -o -type f \( -iname "*.spec.sh" -or -iname "*.test.sh" \) -print0)
fi

for filePath in "${testFiles[@]}"
do
  "$spec_harness" "$( dirname "$filePath" )" "$filePath" "$name_matcher" "$spec_config"
  [ $? -ne 0 ] && test_failed=true
  [ -n "$fail_fast" ] && [ -n "$test_failed" ] && { echo "Failed" >&2; exit 1; }
done

echo
if [ -z "$test_failed" ]
then
  echo "Tests passed"
  exit 0
else
  echo "Tests failed"
  exit 1
fi